<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MonkeyMask Test dApp</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #f59e0b;
            margin: 10px 0;
            font-size: 2.5em;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .status.disconnected {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .status.connected {
            background: #dcfce7;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }
        
        .status.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .btn {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 5px;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #d97706;
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn.secondary {
            background: #6b7280;
        }
        
        .btn.secondary:hover {
            background: #4b5563;
        }
        
        .account-info {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #e5e7eb;
        }
        
        .account-info h3 {
            margin-top: 0;
            color: #374151;
        }
        
        .address {
            font-family: 'Courier New', monospace;
            background: #f3f4f6;
            padding: 10px;
            border-radius: 6px;
            word-break: break-all;
            font-size: 14px;
        }
        
        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .log {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid #374151;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .timestamp {
            color: #9ca3af;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="font-size: 4em;">üêí</div>
            <h1>MonkeyMask Test dApp</h1>
            <p>Test the Banano wallet integration</p>
        </div>
        
        <div id="status" class="status disconnected">
            üîå Not connected to MonkeyMask
        </div>
        
        <div id="account-info" class="account-info" style="display: none;">
            <h3>Connected Account</h3>
            <div id="address" class="address"></div>
        </div>
        
        <div class="actions">
            <button id="connect-btn" class="btn">üîó Connect Wallet</button>
            <button id="disconnect-btn" class="btn secondary" disabled>‚ùå Disconnect</button>
            <button id="get-accounts-btn" class="btn secondary" disabled>üë§ Get Accounts</button>
            <button id="get-balance-btn" class="btn secondary" disabled>üí∞ Get Balance</button>
            <button id="get-account-info-btn" class="btn secondary" disabled>üìä Get Account Info</button>
            <button id="sign-test-btn" class="btn secondary" disabled>‚úçÔ∏è Test Sign Block</button>
            <button id="sign-message-btn" class="btn secondary" disabled>üìù Test Sign Message</button>
            <button id="send-test-btn" class="btn secondary" disabled>üí∏ Test Send Transaction</button>
        </div>
        
        <div id="send-form" class="account-info" style="display: none;">
            <h3>Send Transaction Test</h3>
            <div style="display: grid; gap: 10px;">
                <div>
                    <label style="display: block; font-weight: 500; margin-bottom: 5px;">To Address:</label>
                    <input id="to-address" type="text" placeholder="ban_1... or username.ban" 
                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-family: monospace; font-size: 12px;">
                    <div id="bns-resolution" style="margin-top: 5px; font-size: 11px; display: none;"></div>
                    <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">
                        Supports BNS names: username.ban, username.jtv, username.mictest
                    </div>
                </div>
                <div>
                    <label style="display: block; font-weight: 500; margin-bottom: 5px;">Amount (BAN):</label>
                    <input id="amount" type="number" placeholder="0.01" step="0.01" min="0"
                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
                <button id="send-submit-btn" class="btn" style="margin: 10px 0 0 0;">Send BAN</button>
            </div>
        </div>
        
        <div id="log" class="log">
            <div class="log-entry">
                <span class="timestamp">[Ready]</span> Test dApp loaded. Install MonkeyMask extension and try connecting!
            </div>
        </div>
    </div>

    <script>
        let isConnected = false;
        let connectedAddress = null;
        
        // DOM elements
        const statusEl = document.getElementById('status');
        const accountInfoEl = document.getElementById('account-info');
        const addressEl = document.getElementById('address');
        const logEl = document.getElementById('log');
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const getAccountsBtn = document.getElementById('get-accounts-btn');
        const getBalanceBtn = document.getElementById('get-balance-btn');
        const getAccountInfoBtn = document.getElementById('get-account-info-btn');
        const signTestBtn = document.getElementById('sign-test-btn');
        const signMessageBtn = document.getElementById('sign-message-btn');
        const sendTestBtn = document.getElementById('send-test-btn');
        const sendForm = document.getElementById('send-form');
        const toAddressInput = document.getElementById('to-address');
        const amountInput = document.getElementById('amount');
        const sendSubmitBtn = document.getElementById('send-submit-btn');
        const bnsResolutionEl = document.getElementById('bns-resolution');
        
        // BNS resolution function using the extension's API
        async function resolveBNS(bnsName) {
            try {
                bnsResolutionEl.style.display = 'block';
                bnsResolutionEl.innerHTML = '<span style="color: #3b82f6;">üîÑ Resolving BNS name...</span>';
                
                console.log('BNS: Resolving BNS name via extension API:', bnsName);
                
                // Check if MonkeyMask is available
                if (!window.banano) {
                    throw new Error('MonkeyMask extension not found');
                }
                
                // Use the extension's resolveBNS method
                const resolvedAddress = await window.banano.resolveBNS(bnsName);
                
                console.log('BNS: Resolved to:', resolvedAddress);
                bnsResolutionEl.innerHTML = `<span style="color: #10b981;">‚úÖ Resolved to: ${resolvedAddress}</span>`;
                return resolvedAddress;
                
            } catch (error) {
                console.error('BNS: Failed to resolve', bnsName, ':', error);
                bnsResolutionEl.innerHTML = `<span style="color: #ef4444;">‚ùå Failed to resolve: ${error.message}</span>`;
                throw error;
            }
        }
        
        // Check if input looks like a BNS name
        function isBNSName(input) {
            const parts = input.split('.');
            if (parts.length !== 2) return false;
            const [domain, tld] = parts;
            return ['ban', 'jtv', 'mictest'].includes(tld) && /^[a-zA-Z0-9_-]+$/.test(domain);
        }
        
        // Logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type}]`, message);
        }
        
        // Update UI state
        function updateUI() {
            if (isConnected) {
                statusEl.className = 'status connected';
                statusEl.innerHTML = '‚úÖ Connected to MonkeyMask';
                accountInfoEl.style.display = 'block';
                addressEl.textContent = connectedAddress;
                
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                getAccountsBtn.disabled = false;
                getBalanceBtn.disabled = false;
                getAccountInfoBtn.disabled = false;
                signTestBtn.disabled = false;
                signMessageBtn.disabled = false;
                sendTestBtn.disabled = false;
                sendForm.style.display = 'block';
            } else {
                statusEl.className = 'status disconnected';
                statusEl.innerHTML = 'üîå Not connected to MonkeyMask';
                accountInfoEl.style.display = 'none';
                
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                getAccountsBtn.disabled = true;
                getBalanceBtn.disabled = true;
                getAccountInfoBtn.disabled = true;
                signTestBtn.disabled = true;
                signMessageBtn.disabled = true;
                sendTestBtn.disabled = true;
                sendForm.style.display = 'none';
            }
        }
        
        // Check if MonkeyMask is available
        function checkMonkeyMask() {
            if (typeof window.banano !== 'undefined') {
                log('‚úÖ MonkeyMask detected!');
                return true;
            } else {
                log('‚ùå MonkeyMask not found. Please install the extension.');
                statusEl.className = 'status error';
                statusEl.innerHTML = '‚ùå MonkeyMask extension not found';
                return false;
            }
        }
        
        // Connect to wallet
        async function connectWallet() {
            if (!checkMonkeyMask()) return;
            
            try {
                log('üîÑ Connecting to MonkeyMask...');
                const result = await window.banano.connect();
                
                isConnected = true;
                connectedAddress = result.publicKey || result.address; // Support both formats
                updateUI();
                log(`‚úÖ Connected! Address: ${connectedAddress}`);
                
            } catch (error) {
                log(`‚ùå Connection failed: ${error.message} (Code: ${error.code || 'N/A'})`, 'error');
                statusEl.className = 'status error';
                statusEl.innerHTML = `‚ùå Connection failed: ${error.message}`;
            }
        }
        
        // Disconnect from wallet
        async function disconnectWallet() {
            try {
                await window.banano.disconnect();
                isConnected = false;
                connectedAddress = null;
                updateUI();
                log('üîå Disconnected from MonkeyMask');
            } catch (error) {
                log(`‚ùå Disconnect failed: ${error.message}`, 'error');
            }
        }
        
        // Get accounts
        async function getAccounts() {
            if (!checkMonkeyMask()) return;
            
            try {
                log('üîÑ Getting accounts...');
                const accounts = await window.banano.getAccounts();
                log(`üìã Accounts: ${JSON.stringify(accounts)}`);
            } catch (error) {
                log(`‚ùå Get accounts failed: ${error.message}`, 'error');
            }
        }
        
        // Get balance for connected account
        async function getBalance() {
            if (!checkMonkeyMask()) return;
            
            try {
                log('üîÑ Getting balance...');
                const balance = await window.banano.getBalance();
                log(`üí∞ Balance: ${balance} BAN`);
            } catch (error) {
                log(`‚ùå Get balance failed: ${error.message}`, 'error');
            }
        }
        
        // Get account info for connected account
        async function getAccountInfo() {
            if (!checkMonkeyMask()) return;
            
            try {
                log('üîÑ Getting account info...');
                const accountInfo = await window.banano.getAccountInfo();
                log(`üìä Account Info:`);
                log(`   Address: ${accountInfo.address}`);
                log(`   Balance: ${accountInfo.balance} BAN`);
                log(`   Pending: ${accountInfo.pending} BAN`);
                log(`   Raw Balance: ${accountInfo.rawBalance}`);
                log(`   Raw Pending: ${accountInfo.rawPending}`);
            } catch (error) {
                log(`‚ùå Get account info failed: ${error.message}`, 'error');
            }
        }
        
        // Test block signing
        async function testSignBlock() {
            if (!checkMonkeyMask()) return;
            
            try {
                log('üîÑ Testing block signing...');
                const testBlock = {
                    type: 'send',
                    account: connectedAddress,
                    previous: '0000000000000000000000000000000000000000000000000000000000000000',
                    representative: 'ban_1ka1ium4pfue3uxtntqkkksy3c3s5xy3q3xr8usayqp2yz3h2msc8jqm7yxs',
                    balance: '1000000000000000000000000000000',
                    link: 'ban_1ka1ium4pfue3uxtntqkkksy3c3s5xy3q3xr8usayqp2yz3h2msc8jqm7yxs',
                    amount: '1000000000000000000000000000'
                };
                
                const result = await window.banano.signBlock(testBlock);
                log(`‚úÖ Block signed successfully!`);
                log(`üìù Signature: ${result.signature}`);
            } catch (error) {
                log(`‚ùå Sign block failed: ${error.message} (Code: ${error.code || 'N/A'})`, 'error');
            }
        }
        
        // Test message signing
        async function testSignMessage() {
            if (!checkMonkeyMask()) return;
            
            try {
                log('üîÑ Testing message signing...');
                const testMessage = `Hello from ${window.location.origin}! Timestamp: ${Date.now()}`;
                
                const result = await window.banano.signMessage(testMessage, 'utf8');
                log(`‚úÖ Message signed successfully!`);
                log(`üìù Message: "${testMessage}"`);
                log(`üìù Signature: ${Array.from(result.signature).map(b => b.toString(16).padStart(2, '0')).join('')}`);
                log(`üìù Public Key: ${result.publicKey}`);
            } catch (error) {
                log(`‚ùå Sign message failed: ${error.message} (Code: ${error.code || 'N/A'})`, 'error');
            }
        }
        
        // Test send transaction
        async function testSendTransaction() {
            if (!checkMonkeyMask()) return;
            
            const toAddress = toAddressInput.value.trim();
            const amount = amountInput.value.trim();
            
            if (!toAddress || !amount) {
                log('‚ùå Please enter both address and amount', 'error');
                return;
            }
            
            if (!toAddress.startsWith('ban_')) {
                log('‚ùå Please enter a valid Banano address (starts with ban_)', 'error');
                return;
            }
            
            try {
                log(`üîÑ Sending ${amount} BAN to ${toAddress}...`);
                
                const result = await window.banano.sendTransaction(connectedAddress, toAddress, amount);
                
                log(`‚úÖ Transaction sent successfully!`);
                log(`üìù Hash: ${result.hash}`);
                log(`üßæ Block: ${JSON.stringify(result.block, null, 2)}`);
                
                // Clear form
                toAddressInput.value = '';
                amountInput.value = '';
                
            } catch (error) {
                log(`‚ùå Send transaction failed: ${error.message}`, 'error');
            }
        }
        
        // BNS resolution on address input
        toAddressInput.addEventListener('input', async (e) => {
            const value = e.target.value.trim();
            bnsResolutionEl.style.display = 'none';
            
            if (value && isBNSName(value)) {
                try {
                    const resolvedAddress = await resolveBNS(value);
                    // Update the input field with the resolved address
                    toAddressInput.value = resolvedAddress;
                    log(`üîÑ BNS resolved: ${value} ‚Üí ${resolvedAddress}`);
                } catch (error) {
                    // Error already displayed in resolveBNS
                }
            }
        });
        
        // Event listeners
        connectBtn.addEventListener('click', connectWallet);
        disconnectBtn.addEventListener('click', disconnectWallet);
        getAccountsBtn.addEventListener('click', getAccounts);
        getBalanceBtn.addEventListener('click', getBalance);
        getAccountInfoBtn.addEventListener('click', getAccountInfo);
        signTestBtn.addEventListener('click', testSignBlock);
        signMessageBtn.addEventListener('click', testSignMessage);
        sendTestBtn.addEventListener('click', () => {
            sendForm.style.display = sendForm.style.display === 'none' ? 'block' : 'none';
        });
        sendSubmitBtn.addEventListener('click', testSendTransaction);
        
        // Setup provider event listeners
        function setupProviderEvents() {
            if (window.banano && typeof window.banano.on === 'function') {
                // Connect event
                window.banano.on('connect', (data) => {
                    log(`üéâ Provider Event: Connected to ${data.publicKey}`);
                    isConnected = true;
                    connectedAddress = data.publicKey;
                    updateUI();
                });
                
                // Disconnect event
                window.banano.on('disconnect', () => {
                    log(`üîå Provider Event: Disconnected`);
                    isConnected = false;
                    connectedAddress = null;
                    updateUI();
                });
                
                // Account changed event
                window.banano.on('accountChanged', (publicKey) => {
                    log(`üë§ Provider Event: Account changed to ${publicKey}`);
                    connectedAddress = publicKey;
                    updateUI();
                });
                
                log('üì° Provider event listeners set up');
                
                // Check initial connection state
                checkInitialConnectionState();
            }
        }
        
        // Check if we're already connected (for page refresh scenarios)
        function checkInitialConnectionState() {
            if (window.banano && window.banano.isConnected && window.banano.publicKey) {
                log(`üîÑ Initial state: Already connected to ${window.banano.publicKey}`);
                isConnected = true;
                connectedAddress = window.banano.publicKey;
                updateUI();
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            log('üöÄ Test dApp initialized');
            
            // Listen for MonkeyMask initialization
            window.addEventListener('banano#initialized', (event) => {
                log('üéâ MonkeyMask initialized!');
                checkMonkeyMask();
                setupProviderEvents();
            });
            
            // Check if already available
            setTimeout(() => {
                checkMonkeyMask();
                setupProviderEvents();
            }, 1000);
            updateUI();
        });
    </script>
</body>
</html>
